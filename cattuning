import optuna
from catboost import CatBoostRegressor, Pool
import numpy as np
import pandas as pd

# Assume X_train, y_train are your training features and target variable respectively
# Assume X_valid, y_valid are your validation features and target variable respectively
# Replace these with your actual data
X_train = np.random.rand(1000, 400)  # Dummy data, replace with your actual training data
y_train = np.random.rand(1000)       # Dummy data, replace with your actual training data
X_valid = np.random.rand(200, 400)   # Dummy data, replace with your actual validation data
y_valid = np.random.rand(200)        # Dummy data, replace with your actual validation data

# Create Pool objects for the training and validation sets
train_pool = Pool(X_train, y_train)
valid_pool = Pool(X_valid, y_valid)

def objective(trial):
    # Define the hyperparameter configuration space
    param = {
        'iterations': trial.suggest_int('iterations', 100, 1000),
        'depth': trial.suggest_int('depth', 6, 10),
        'learning_rate': trial.suggest_float('learning_rate', 0.01, 0.3),
        'random_strength': trial.suggest_int('random_strength', 1, 20),
        'bagging_temperature': trial.suggest_float('bagging_temperature', 0, 1),
        'l2_leaf_reg': trial.suggest_int('l2_leaf_reg', 1, 10),
        'border_count': trial.suggest_int('border_count', 32, 255),
        'ctr_border_count': trial.suggest_int('ctr_border_count', 50, 200),
        'leaf_estimation_iterations': trial.suggest_int('leaf_estimation_iterations', 1, 10),
        'bootstrap_type': trial.suggest_categorical('bootstrap_type', ['Bayesian', 'Bernoulli', 'MVS']),
        'subsample': trial.suggest_float('subsample', 0.5, 1) if trial.suggest_categorical('bootstrap_type', ['Bernoulli', 'MVS']) else None,
        'loss_function': 'RMSE',
        'eval_metric': 'RMSE',
        'od_type': 'Iter',
        'od_wait': 50
    }
    
    # Instantiate the CatBoost model
    catboost_model = CatBoostRegressor(**param)
    
    # Fit model with the training set and evaluate it on the validation set
    catboost_model.fit(train_pool, eval_set=valid_pool, verbose=0, plot=False)
    
    # Get the evaluation results
    evals_result = catboost_model.get_evals_result()
    
    # Return the last RMSE value from the evaluation results on the validation set
    # Optuna tries to minimize the objective, so if you have a different metric, ensure it's being minimized
    rmse = evals_result['validation']['RMSE'][-1]
    
    return rmse

# Create a study object and specify the direction is 'minimize'.
study = optuna.create_study(direction='minimize')

# Start the hyperparameter optimization
study.optimize(objective, n_trials=50)  # You can increase n_trials for a thorough search

# Fetch the best hyperparameters
best_params = study.best_params

print(f"Best parameters: {best_params}")
